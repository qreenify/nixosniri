#!/usr/bin/env bash
set -euo pipefail

# Mic icons
ICON_LIVE="󰍬"  # Nerd font mic icon
ICON_MUTED="󰍭"  # Nerd font muted mic icon

TEXT="$ICON_MUTED"
ALT="unknown"; CLASS="unknown"; TIP="Mic: unknown"

if command -v wpctl >/dev/null 2>&1; then
  S=$(wpctl get-volume @DEFAULT_AUDIO_SOURCE@ 2>/dev/null || true)
  if echo "$S" | grep -q '\[MUTED\]'; then
    TEXT="$ICON_MUTED"
    ALT="muted"; CLASS="muted"; TIP="Mic: muted"
  elif [[ -n "$S" ]]; then
    TEXT="$ICON_LIVE"
    ALT="live"; CLASS="live"; TIP="Mic: live"
  fi
elif command -v pactl >/dev/null 2>&1; then
  M=$(pactl get-source-mute @DEFAULT_SOURCE@ 2>/dev/null || true)
  if echo "$M" | grep -iq 'yes'; then
    TEXT="$ICON_MUTED"
    ALT="muted"; CLASS="muted"; TIP="Mic: muted"
  elif [[ -n "$M" ]]; then
    TEXT="$ICON_LIVE"
    ALT="live"; CLASS="live"; TIP="Mic: live"
  fi
fi

# Waybar custom module (return-type=json)
printf '{"text":"%s","alt":"%s","class":"%s","tooltip":"%s"}\n' "$TEXT" "$ALT" "$CLASS" "$TIP"
